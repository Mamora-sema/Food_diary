<!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}–î–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è - {{ summary.date.strftime('%d.%m.%Y') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º -->
        <div class="card mb-3 date-nav">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('index', date=(summary.date - timedelta(days=1)).isoformat()) }}"
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-chevron-left"></i>
                        <span class="d-none d-sm-inline">–í—á–µ—Ä–∞</span>
                    </a>

                    <div class="text-center flex-grow-1 mx-2">
                        <h5 class="mb-0">
                            {% if summary.date == today %}
                                –°–µ–≥–æ–¥–Ω—è
                            {% else %}
                                {{ summary.date.strftime('%d.%m.%Y') }}
                            {% endif %}
                        </h5>
                        <input type="date" class="form-control form-control-sm mt-1 mx-auto"
                               style="max-width: 140px;"
                               id="dateSelector" value="{{ summary.date.isoformat() }}"
                               onchange="window.location.href='?date=' + this.value">
                    </div>

                    <a href="{{ url_for('index', date=(summary.date + timedelta(days=1)).isoformat()) }}"
                       class="btn btn-outline-secondary btn-sm">
                        <span class="d-none d-sm-inline">–ó–∞–≤—Ç—Ä–∞</span>
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
        <div class="card mb-3 d-lg-none">
            <div class="card-body py-2">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="fw-bold text-success">{{ summary.totals.calories|round(0)|int }}</div>
                        <small class="text-muted">–ö–∫–∞–ª</small>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold text-danger">{{ summary.totals.protein|round(0)|int }}–≥</div>
                        <small class="text-muted">–ë–µ–ª–∫–∏</small>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold text-warning">{{ summary.totals.fat|round(0)|int }}–≥</div>
                        <small class="text-muted">–ñ–∏—Ä—ã</small>
                    </div>
                    <div class="col-3">
                        <div class="fw-bold text-primary">{{ summary.totals.carbs|round(0)|int }}–≥</div>
                        <small class="text-muted">–£–≥–ª–µ–≤.</small>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar bg-success"
                         style="width: {{ [summary.percentages.calories, 100]|min }}%"></div>
                </div>
                <small class="text-muted">{{ summary.percentages.calories }}% –æ—Ç –Ω–æ—Ä–º—ã ({{ summary.goals.calories|int }} –∫–∫–∞–ª)</small>
            </div>
        </div>

        <!-- –ü—Ä–∏—ë–º—ã –ø–∏—â–∏ -->
        {% for meal_key, meal_name in meal_types.items() %}
        <div class="card mb-2 meal-card fade-in">
            <div class="card-header d-flex justify-content-between align-items-center py-2
                        {% if meal_key == 'breakfast' %}bg-warning-subtle
                        {% elif meal_key == 'lunch' %}bg-success-subtle
                        {% elif meal_key == 'dinner' %}bg-info-subtle
                        {% else %}bg-secondary-subtle{% endif %}"
                 data-bs-toggle="collapse"
                 data-bs-target="#collapse-{{ meal_key }}"
                 aria-expanded="true">

                <div class="d-flex align-items-center">
                    <i class="bi bi-chevron-down me-2 collapse-icon" id="icon-{{ meal_key }}"></i>
                    <h6 class="mb-0">
                        {% if meal_key == 'breakfast' %}<i class="bi bi-sunrise"></i>
                        {% elif meal_key == 'lunch' %}<i class="bi bi-sun"></i>
                        {% elif meal_key == 'dinner' %}<i class="bi bi-moon"></i>
                        {% else %}<i class="bi bi-cup-hot"></i>{% endif %}
                        {{ meal_name }}
                    </h6>
                </div>

                <div class="d-flex align-items-center gap-2 meal-summary-inline">
                    <span class="fw-bold">{{ summary.meal_totals[meal_key].calories|round(0)|int }}</span>
                    <span class="text-danger">–ë:{{ summary.meal_totals[meal_key].protein|round(0)|int }}</span>
                    <span class="text-warning">–ñ:{{ summary.meal_totals[meal_key].fat|round(0)|int }}</span>
                    <span class="text-primary">–£:{{ summary.meal_totals[meal_key].carbs|round(0)|int }}</span>
                </div>
            </div>

            <div class="collapse show" id="collapse-{{ meal_key }}">
                <div class="card-body py-2 px-2 px-sm-3">
                    {% if summary.meals[meal_key] %}
                        <!-- –ú–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥ - –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                        <div class="d-md-none">
                            {% for item in summary.meals[meal_key] %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div class="flex-grow-1">
                                    <div class="fw-medium">
                                        {{ item.product.name }}
                                        {% if item.product.is_recipe %}
                                        <i class="bi bi-book text-warning small"></i>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        {{ item.weight|int }}–≥ ¬∑
                                        <span class="text-danger">–ë:{{ item.nutrition.protein|round(0)|int }}</span>
                                        <span class="text-warning">–ñ:{{ item.nutrition.fat|round(0)|int }}</span>
                                        <span class="text-primary">–£:{{ item.nutrition.carbs|round(0)|int }}</span>
                                    </small>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="fw-bold">{{ item.nutrition.calories|round(0)|int }}</span>
                                    <form action="{{ url_for('delete_meal', entry_id=item.id) }}"
                                          method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-link text-danger p-0"
                                                onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –≤–∏–¥ - —Ç–∞–±–ª–∏—Ü–∞ -->
                        <div class="d-none d-md-block">
                            <table class="table table-sm table-hover mb-2">
                                <thead>
                                    <tr class="small text-muted">
                                        <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                                        <th class="text-center">–í–µ—Å</th>
                                        <th class="text-center">–ë</th>
                                        <th class="text-center">–ñ</th>
                                        <th class="text-center">–£</th>
                                        <th class="text-center">–ö–∫–∞–ª</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in summary.meals[meal_key] %}
                                    <tr>
                                        <td>
                                            {{ item.product.name }}
                                            {% if item.product.is_recipe %}
                                            <i class="bi bi-book text-warning small"></i>
                                            {% endif %}
                                        </td>
                                        <td class="text-center text-muted">{{ item.weight|int }}–≥</td>
                                        <td class="text-center text-danger">{{ item.nutrition.protein|round(1) }}</td>
                                        <td class="text-center text-warning">{{ item.nutrition.fat|round(1) }}</td>
                                        <td class="text-center text-primary">{{ item.nutrition.carbs|round(1) }}</td>
                                        <td class="text-center fw-bold">{{ item.nutrition.calories|round(0)|int }}</td>
                                        <td class="text-end">
                                            <form action="{{ url_for('delete_meal', entry_id=item.id) }}"
                                                  method="POST" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-1"
                                                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å?')">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted small mb-2 text-center">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                    {% endif %}

                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-success"
                                data-bs-toggle="modal" data-bs-target="#addMealModal"
                                data-meal-type="{{ meal_key }}"
                                onclick="event.stopPropagation();">
                            <i class="bi bi-plus-lg"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ) -->
    <div class="col-lg-4 d-none d-lg-block">
        <div class="card sticky-top summary-card" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> –ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å</h5>
            </div>
            <div class="card-body">
                <!-- –ö–∞–ª–æ—Ä–∏–∏ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–ö–∞–ª–æ—Ä–∏–∏</span>
                        <span class="fw-bold">{{ summary.totals.calories|round(0)|int }} / {{ summary.goals.calories|int }}</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success"
                             style="width: {{ [summary.percentages.calories, 100]|min }}%"></div>
                    </div>
                    <small class="text-muted">{{ summary.percentages.calories }}% –æ—Ç –Ω–æ—Ä–º—ã</small>
                </div>

                <!-- –ë–µ–ª–∫–∏ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-danger"><i class="bi bi-circle-fill"></i> –ë–µ–ª–∫–∏</span>
                        <span>{{ summary.totals.protein|round(1) }} / {{ summary.goals.protein|int }} –≥</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger"
                             style="width: {{ [summary.percentages.protein, 100]|min }}%"></div>
                    </div>
                </div>

                <!-- –ñ–∏—Ä—ã -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-warning"><i class="bi bi-circle-fill"></i> –ñ–∏—Ä—ã</span>
                        <span>{{ summary.totals.fat|round(1) }} / {{ summary.goals.fat|int }} –≥</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning"
                             style="width: {{ [summary.percentages.fat, 100]|min }}%"></div>
                    </div>
                </div>

                <!-- –£–≥–ª–µ–≤–æ–¥—ã -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-primary"><i class="bi bi-circle-fill"></i> –£–≥–ª–µ–≤–æ–¥—ã</span>
                        <span>{{ summary.totals.carbs|round(1) }} / {{ summary.goals.carbs|int }} –≥</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary"
                             style="width: {{ [summary.percentages.carbs, 100]|min }}%"></div>
                    </div>
                </div>

                <hr>

                <!-- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ë–ñ–£ -->
                <h6>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ë–ñ–£</h6>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-danger" style="width: {{ summary.macro_breakdown.protein }}%">
                        {% if summary.macro_breakdown.protein > 15 %}{{ summary.macro_breakdown.protein|round(0)|int }}%{% endif %}
                    </div>
                    <div class="progress-bar bg-warning" style="width: {{ summary.macro_breakdown.fat }}%">
                        {% if summary.macro_breakdown.fat > 15 %}{{ summary.macro_breakdown.fat|round(0)|int }}%{% endif %}
                    </div>
                    <div class="progress-bar bg-primary" style="width: {{ summary.macro_breakdown.carbs }}%">
                        {% if summary.macro_breakdown.carbs > 15 %}{{ summary.macro_breakdown.carbs|round(0)|int }}%{% endif %}
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-1 small text-muted">
                    <span>–ë: {{ summary.macro_breakdown.protein }}%</span>
                    <span>–ñ: {{ summary.macro_breakdown.fat }}%</span>
                    <span>–£: {{ summary.macro_breakdown.carbs }}%</span>
                </div>

                <hr>

                <a href="{{ url_for('daily_summary', date=summary.date.isoformat()) }}"
                   class="btn btn-outline-success w-100">
                    <i class="bi bi-bar-chart"></i> –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–≤–æ–¥–∫–∞
                </a>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="modal fade" id="addMealModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('add_meal') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="date" value="{{ summary.date.isoformat() }}">

                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–∏—ë–º –ø–∏—â–∏</label>
                        <select name="meal_type" id="modalMealType" class="form-select" required>
                            {% for key, name in meal_types.items() %}
                            <option value="{{ key }}">{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ü—Ä–æ–¥—É–∫—Ç</label>
                        <input type="text" id="productSearch" class="form-control mb-2"
                               placeholder="üîç –ü–æ–∏—Å–∫...">
                        <select name="product_id" id="productSelect" class="form-select" required size="5">
                            {% for product in products %}
                            <option value="{{ product.id }}"
                                    data-calories="{{ product.calories }}"
                                    data-protein="{{ product.protein }}"
                                    data-fat="{{ product.fat }}"
                                    data-carbs="{{ product.carbs }}">
                                {{ product.name }} ({{ product.calories|round(0)|int }} –∫–∫–∞–ª)
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        <div class="d-flex gap-1 mb-2 flex-wrap">
                            <button type="button" class="btn btn-outline-secondary btn-sm weight-btn" data-weight="50">50–≥</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm weight-btn active" data-weight="100">100–≥</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm weight-btn" data-weight="150">150–≥</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm weight-btn" data-weight="200">200–≥</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm weight-btn" data-weight="250">250–≥</button>
                        </div>
                        <div class="input-group">
                            <input type="number" name="weight" id="weightInput" class="form-control"
                                   value="100" min="1" max="2000" required>
                            <span class="input-group-text">–≥—Ä–∞–º–º</span>
                        </div>
                    </div>

                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
                    <div class="card bg-light nutrition-preview">
                        <div class="card-body py-2">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="fw-bold fs-5" id="previewCalories">0</div>
                                    <small class="text-muted">–ö–∫–∞–ª</small>
                                </div>
                                <div class="col-3">
                                    <div class="fw-bold fs-5 text-danger" id="previewProtein">0</div>
                                    <small class="text-muted">–ë</small>
                                </div>
                                <div class="col-3">
                                    <div class="fw-bold fs-5 text-warning" id="previewFat">0</div>
                                    <small class="text-muted">–ñ</small>
                                </div>
                                <div class="col-3">
                                    <div class="fw-bold fs-5 text-primary" id="previewCarbs">0</div>
                                    <small class="text-muted">–£</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <a href="{{ url_for('add_product') }}" class="btn btn-outline-primary btn-sm me-auto">
                        <i class="bi bi-plus"></i> –ù–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
                    </a>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function(header) {
        const targetId = header.getAttribute('data-bs-target');
        if (!targetId) return;

        const target = document.querySelector(targetId);
        if (!target) return;

        const mealKey = targetId.replace('#collapse-', '');
        const icon = document.getElementById('icon-' + mealKey);

        if (icon) {
            target.addEventListener('show.bs.collapse', function() {
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
            });

            target.addEventListener('hide.bs.collapse', function() {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
            });
        }
    });
});
</script>
{% endblock %}