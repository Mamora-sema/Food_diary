<!-- templates/daily_summary.html -->
{% extends "base.html" %}

{% block title %}Сводка за {{ target_date.strftime('%d.%m.%Y') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h4 class="mb-0">
                <i class="bi bi-bar-chart"></i>
                Сводка за {{ target_date.strftime('%d.%m.%Y') }}
            </h4>
            <div class="d-flex gap-2">
                <a href="{{ url_for('daily_summary', date=(target_date - timedelta(days=1)).isoformat()) }}"
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <a href="{{ url_for('index', date=target_date.isoformat()) }}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-journal"></i> К дневнику
                </a>
                <a href="{{ url_for('daily_summary', date=(target_date + timedelta(days=1)).isoformat()) }}"
                   class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Stats -->
    <div class="col-lg-8">
        <!-- Calories Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white py-2">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Калории</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-5 col-md-4 text-center">
                        <h1 class="display-5 text-success mb-0" id="totalCalories">0</h1>
                        <p class="text-muted mb-0 small">из <span id="goalCalories">2000</span> ккал</p>
                    </div>
                    <div class="col-7 col-md-8">
                        <div class="progress mb-2" style="height: 25px;">
                            <div class="progress-bar bg-success" id="caloriesProgress" style="width: 0%">
                                <span id="caloriesPercentText">0%</span>
                            </div>
                        </div>
                        <div class="row text-center small">
                            <div class="col-4">
                                <div class="fw-bold" id="remainingCalories">0</div>
                                <small class="text-muted" id="remainingLabel">Осталось</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold" id="caloriesPercent">0%</div>
                                <small class="text-muted">От нормы</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold" id="goalCaloriesDisplay">2000</div>
                                <small class="text-muted">Цель</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Macros Cards -->
        <div class="row">
            <div class="col-4">
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-egg"></i> Белки</h6>
                    </div>
                    <div class="card-body text-center py-3">
                        <h3 class="text-danger mb-0"><span id="totalProtein">0</span><small class="fs-6">г</small></h3>
                        <p class="text-muted mb-1 small">из <span id="goalProtein">50</span>г</p>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-danger" id="proteinProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted"><span id="proteinPercent">0</span>%</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning py-2">
                        <h6 class="mb-0"><i class="bi bi-droplet"></i> Жиры</h6>
                    </div>
                    <div class="card-body text-center py-3">
                        <h3 class="text-warning mb-0"><span id="totalFat">0</span><small class="fs-6">г</small></h3>
                        <p class="text-muted mb-1 small">из <span id="goalFat">65</span>г</p>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-warning" id="fatProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted"><span id="fatPercent">0</span>%</small>
                    </div>
                </div>
            </div>
            <div class="col-4">
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0"><i class="bi bi-basket"></i> Углеводы</h6>
                    </div>
                    <div class="card-body text-center py-3">
                        <h3 class="text-primary mb-0"><span id="totalCarbs">0</span><small class="fs-6">г</small></h3>
                        <p class="text-muted mb-1 small">из <span id="goalCarbs">300</span>г</p>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-primary" id="carbsProgress" style="width: 0%"></div>
                        </div>
                        <small class="text-muted"><span id="carbsPercent">0</span>%</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Macro Breakdown -->
        <div class="card mb-4">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Распределение макронутриентов</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <h6 class="small text-muted">По весу (граммы)</h6>
                        <div class="progress" style="height: 28px;">
                            <div class="progress-bar bg-danger" id="macroProteinBar" style="width: 33%">
                                <span class="small">Б <span id="macroProteinPercent">33</span>%</span>
                            </div>
                            <div class="progress-bar bg-warning" id="macroFatBar" style="width: 33%">
                                <span class="small">Ж <span id="macroFatPercent">33</span>%</span>
                            </div>
                            <div class="progress-bar bg-primary" id="macroCarbsBar" style="width: 34%">
                                <span class="small">У <span id="macroCarbsPercent">34</span>%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="small text-muted">По калориям</h6>
                        <div class="progress" style="height: 28px;">
                            <div class="progress-bar bg-danger" id="calProteinBar" style="width: 20%">
                                <span class="small">Б <span id="calProteinPercent">20</span>%</span>
                            </div>
                            <div class="progress-bar bg-warning" id="calFatBar" style="width: 40%">
                                <span class="small">Ж <span id="calFatPercent">40</span>%</span>
                            </div>
                            <div class="progress-bar bg-primary" id="calCarbsBar" style="width: 40%">
                                <span class="small">У <span id="calCarbsPercent">40</span>%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i> Белки и углеводы: 4 ккал/г, Жиры: 9 ккал/г
                </div>
            </div>
        </div>

        <!-- Meals Breakdown -->
        <div class="card mb-4">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-clock"></i> По приемам пищи</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Прием пищи</th>
                                <th class="text-center">Ккал</th>
                                <th class="text-center d-none d-sm-table-cell">Белки</th>
                                <th class="text-center d-none d-sm-table-cell">Жиры</th>
                                <th class="text-center d-none d-sm-table-cell">Углеводы</th>
                                <th class="text-center">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for meal_key, meal_name in meal_types.items() %}
                            <tr>
                                <td>
                                    {% if meal_key == 'breakfast' %}<i class="bi bi-sunrise text-warning"></i>
                                    {% elif meal_key == 'lunch' %}<i class="bi bi-sun text-success"></i>
                                    {% elif meal_key == 'dinner' %}<i class="bi bi-moon text-info"></i>
                                    {% else %}<i class="bi bi-cup-hot text-secondary"></i>{% endif %}
                                    <span>{{ meal_name }}</span>
                                </td>
                                <td class="text-center fw-bold" id="meal-{{ meal_key }}-cal">0</td>
                                <td class="text-center text-danger d-none d-sm-table-cell" id="meal-{{ meal_key }}-prot">0</td>
                                <td class="text-center text-warning d-none d-sm-table-cell" id="meal-{{ meal_key }}-fat">0</td>
                                <td class="text-center text-primary d-none d-sm-table-cell" id="meal-{{ meal_key }}-carb">0</td>
                                <td class="text-center" id="meal-{{ meal_key }}-percent">0%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-success">
                            <tr class="fw-bold">
                                <td>Итого</td>
                                <td class="text-center" id="totalCaloriesTable">0</td>
                                <td class="text-center text-danger d-none d-sm-table-cell" id="totalProteinTable">0</td>
                                <td class="text-center text-warning d-none d-sm-table-cell" id="totalFatTable">0</td>
                                <td class="text-center text-primary d-none d-sm-table-cell" id="totalCarbsTable">0</td>
                                <td class="text-center">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products List -->
        <div class="card mb-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-ul"></i> Все продукты за день</h6>
                <span class="badge bg-success" id="productsCount">0</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0" id="productsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Продукт</th>
                                <th class="text-center">Вес</th>
                                <th class="text-center">Ккал</th>
                                <th class="text-center d-none d-sm-table-cell">Б</th>
                                <th class="text-center d-none d-sm-table-cell">Ж</th>
                                <th class="text-center d-none d-sm-table-cell">У</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    Загрузка...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- RSK Progress -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white py-2">
                <h6 class="mb-0"><i class="bi bi-check2-circle"></i> % от дневной нормы</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between small">
                        <span>Калории</span>
                        <span class="fw-bold" id="rskCaloriesPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 18px;">
                        <div class="progress-bar" id="rskCaloriesProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between small">
                        <span><span class="text-danger">●</span> Белки</span>
                        <span class="fw-bold" id="rskProteinPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar bg-danger" id="rskProteinProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between small">
                        <span><span class="text-warning">●</span> Жиры</span>
                        <span class="fw-bold" id="rskFatPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar bg-warning" id="rskFatProgress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-0">
                    <div class="d-flex justify-content-between small">
                        <span><span class="text-primary">●</span> Углеводы</span>
                        <span class="fw-bold" id="rskCarbsPercent">0%</span>
                    </div>
                    <div class="progress" style="height: 12px;">
                        <div class="progress-bar bg-primary" id="rskCarbsProgress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Remaining -->
        <div class="card mb-4">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-arrow-down-up"></i> Осталось / Превышено</h6>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="ps-3">Калории</td>
                        <td class="text-end pe-3 fw-bold" id="remainingCaloriesRow">0 ккал</td>
                    </tr>
                    <tr>
                        <td class="ps-3">Белки</td>
                        <td class="text-end pe-3" id="remainingProteinRow">0 г</td>
                    </tr>
                    <tr>
                        <td class="ps-3">Жиры</td>
                        <td class="text-end pe-3" id="remainingFatRow">0 г</td>
                    </tr>
                    <tr>
                        <td class="ps-3">Углеводы</td>
                        <td class="text-end pe-3" id="remainingCarbsRow">0 г</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- User Stats -->
        <div class="card mb-4">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-person"></i> Ваши показатели</h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="fs-4 fw-bold text-success" id="userWeight">70</div>
                        <small class="text-muted">Ваш вес (кг)</small>
                    </div>
                    <div class="col-6">
                        <div class="fs-4 fw-bold text-primary" id="totalProductsCount">0</div>
                        <small class="text-muted">Продуктов</small>
                    </div>
                </div>

                <hr>

                <div class="row text-center">
                    <div class="col-6">
                        <div class="fs-5 fw-bold text-danger" id="proteinPerKg">0</div>
                        <small class="text-muted">Белков (г/кг)</small>
                    </div>
                    <div class="col-6">
                        <div class="fs-5 fw-bold text-warning" id="caloriesPerKg">0</div>
                        <small class="text-muted">Ккал/кг</small>
                    </div>
                </div>

                <div class="alert alert-light mt-3 mb-0 small py-2">
                    <i class="bi bi-lightbulb text-warning"></i>
                    <strong>Рекомендация:</strong> 1.5-2.2 г белка на кг веса для активных людей
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header py-2">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> Быстрые действия</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('index', date=target_date.isoformat()) }}" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle"></i> Добавить продукт
                    </a>
                    <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-gear"></i> Изменить норму
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading spinner -->
<div class="position-fixed top-50 start-50 translate-middle" id="loadingSpinner" style="z-index: 9999;">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Загрузка...</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const CURRENT_DATE = '{{ target_date.isoformat() }}';
const MEAL_TYPES = ['breakfast', 'lunch', 'dinner', 'snack'];
const MEAL_NAMES = {
    'breakfast': 'Завтрак',
    'lunch': 'Обед',
    'dinner': 'Ужин',
    'snack': 'Перекус'
};

let appData = {
    user: { weight: 70 },
    products: [],
    entries: [],
    goals: { calories: 2000, protein: 50, fat: 65, carbs: 300 }
};

async function loadData() {
    try {
        const response = await fetch('/api/sync');
        const result = await response.json();

        if (result.success) {
            appData.user = result.data.user || { weight: 70 };
            appData.products = result.data.products || [];
            appData.entries = result.data.entries || [];
            appData.goals = result.data.goals || appData.goals;

            // Сохраняем в localStorage
            localStorage.setItem('appData', JSON.stringify(appData));

            renderSummary();
        }
    } catch (error) {
        console.error('Load error:', error);
        // Пробуем загрузить из кэша
        const cached = localStorage.getItem('appData');
        if (cached) {
            appData = JSON.parse(cached);
            renderSummary();
        }
    }

    document.getElementById('loadingSpinner').style.display = 'none';
}

function calculateNutrition(entry) {
    const product = appData.products.find(p => p.id === entry.product_id);
    if (!product) return { calories: 0, protein: 0, fat: 0, carbs: 0 };

    const multiplier = entry.weight / 100;
    return {
        calories: product.calories * multiplier,
        protein: product.protein * multiplier,
        fat: product.fat * multiplier,
        carbs: product.carbs * multiplier
    };
}

function renderSummary() {
    const todayEntries = appData.entries.filter(e => e.date === CURRENT_DATE);
    const goals = appData.goals;
    const userWeight = appData.user?.weight || 70;

    // Расчёт итогов
    const totals = { calories: 0, protein: 0, fat: 0, carbs: 0 };
    const mealTotals = {};
    MEAL_TYPES.forEach(type => {
        mealTotals[type] = { calories: 0, protein: 0, fat: 0, carbs: 0, items: [] };
    });

    todayEntries.forEach(entry => {
        const nutrition = entry.nutrition || calculateNutrition(entry);
        totals.calories += nutrition.calories;
        totals.protein += nutrition.protein;
        totals.fat += nutrition.fat;
        totals.carbs += nutrition.carbs;

        if (mealTotals[entry.meal_type]) {
            mealTotals[entry.meal_type].calories += nutrition.calories;
            mealTotals[entry.meal_type].protein += nutrition.protein;
            mealTotals[entry.meal_type].fat += nutrition.fat;
            mealTotals[entry.meal_type].carbs += nutrition.carbs;
            mealTotals[entry.meal_type].items.push({
                ...entry,
                nutrition
            });
        }
    });

    // ==================== КАЛОРИИ ====================
    const caloriesPercent = Math.round((totals.calories / goals.calories) * 100);
    const caloriesPercentCapped = Math.min(100, caloriesPercent);

    document.getElementById('totalCalories').textContent = Math.round(totals.calories);
    document.getElementById('goalCalories').textContent = Math.round(goals.calories);
    document.getElementById('goalCaloriesDisplay').textContent = Math.round(goals.calories);
    document.getElementById('caloriesProgress').style.width = `${caloriesPercentCapped}%`;
    document.getElementById('caloriesPercentText').textContent = `${caloriesPercent}%`;
    document.getElementById('caloriesPercent').textContent = `${caloriesPercent}%`;

    // Цвет прогресс-бара калорий
    const caloriesProgressBar = document.getElementById('caloriesProgress');
    if (caloriesPercent > 100) {
        caloriesProgressBar.classList.remove('bg-success');
        caloriesProgressBar.classList.add('bg-danger');
    } else {
        caloriesProgressBar.classList.remove('bg-danger');
        caloriesProgressBar.classList.add('bg-success');
    }

    const remainingCalories = Math.round(goals.calories - totals.calories);
    const remainingEl = document.getElementById('remainingCalories');
    const remainingLabelEl = document.getElementById('remainingLabel');
    if (remainingCalories >= 0) {
        remainingEl.textContent = remainingCalories;
        remainingEl.className = 'fw-bold text-success';
        remainingLabelEl.textContent = 'Осталось';
    } else {
        remainingEl.textContent = Math.abs(remainingCalories);
        remainingEl.className = 'fw-bold text-danger';
        remainingLabelEl.textContent = 'Превышено';
    }

    // ==================== МАКРОНУТРИЕНТЫ ====================
    const proteinPercent = Math.round((totals.protein / goals.protein) * 100);
    const fatPercent = Math.round((totals.fat / goals.fat) * 100);
    const carbsPercent = Math.round((totals.carbs / goals.carbs) * 100);

    document.getElementById('totalProtein').textContent = totals.protein.toFixed(1);
    document.getElementById('goalProtein').textContent = Math.round(goals.protein);
    document.getElementById('proteinProgress').style.width = `${Math.min(100, proteinPercent)}%`;
    document.getElementById('proteinPercent').textContent = proteinPercent;

    document.getElementById('totalFat').textContent = totals.fat.toFixed(1);
    document.getElementById('goalFat').textContent = Math.round(goals.fat);
    document.getElementById('fatProgress').style.width = `${Math.min(100, fatPercent)}%`;
    document.getElementById('fatPercent').textContent = fatPercent;

    document.getElementById('totalCarbs').textContent = totals.carbs.toFixed(1);
    document.getElementById('goalCarbs').textContent = Math.round(goals.carbs);
    document.getElementById('carbsProgress').style.width = `${Math.min(100, carbsPercent)}%`;
    document.getElementById('carbsPercent').textContent = carbsPercent;

    // ==================== СООТНОШЕНИЕ БЖУ ПО ВЕСУ ====================
    const totalMacros = totals.protein + totals.fat + totals.carbs;
    if (totalMacros > 0) {
        const pPct = Math.round((totals.protein / totalMacros) * 100);
        const fPct = Math.round((totals.fat / totalMacros) * 100);
        const cPct = 100 - pPct - fPct;

        document.getElementById('macroProteinBar').style.width = `${pPct}%`;
        document.getElementById('macroProteinPercent').textContent = pPct;
        document.getElementById('macroFatBar').style.width = `${fPct}%`;
        document.getElementById('macroFatPercent').textContent = fPct;
        document.getElementById('macroCarbsBar').style.width = `${cPct}%`;
        document.getElementById('macroCarbsPercent').textContent = cPct;
    }

    // ==================== СООТНОШЕНИЕ ПО КАЛОРИЯМ ====================
    const calFromProtein = totals.protein * 4;
    const calFromFat = totals.fat * 9;
    const calFromCarbs = totals.carbs * 4;
    const totalCalFromMacros = calFromProtein + calFromFat + calFromCarbs;

    if (totalCalFromMacros > 0) {
        const pCalPct = Math.round((calFromProtein / totalCalFromMacros) * 100);
        const fCalPct = Math.round((calFromFat / totalCalFromMacros) * 100);
        const cCalPct = 100 - pCalPct - fCalPct;

        document.getElementById('calProteinBar').style.width = `${pCalPct}%`;
        document.getElementById('calProteinPercent').textContent = pCalPct;
        document.getElementById('calFatBar').style.width = `${fCalPct}%`;
        document.getElementById('calFatPercent').textContent = fCalPct;
        document.getElementById('calCarbsBar').style.width = `${cCalPct}%`;
        document.getElementById('calCarbsPercent').textContent = cCalPct;
    }

    // ==================== ТАБЛИЦА ПО ПРИЁМАМ ПИЩИ ====================
    MEAL_TYPES.forEach(type => {
        const meal = mealTotals[type];
        document.getElementById(`meal-${type}-cal`).textContent = Math.round(meal.calories);
        document.getElementById(`meal-${type}-prot`).textContent = meal.protein.toFixed(1);
        document.getElementById(`meal-${type}-fat`).textContent = meal.fat.toFixed(1);
        document.getElementById(`meal-${type}-carb`).textContent = meal.carbs.toFixed(1);

        const mealPercent = totals.calories > 0 ? Math.round((meal.calories / totals.calories) * 100) : 0;
        document.getElementById(`meal-${type}-percent`).textContent = `${mealPercent}%`;
    });

    document.getElementById('totalCaloriesTable').textContent = Math.round(totals.calories);
    document.getElementById('totalProteinTable').textContent = totals.protein.toFixed(1);
    document.getElementById('totalFatTable').textContent = totals.fat.toFixed(1);
    document.getElementById('totalCarbsTable').textContent = totals.carbs.toFixed(1);

    // ==================== СПИСОК ПРОДУКТОВ ====================
    const productsTableBody = document.getElementById('productsTableBody');
    if (todayEntries.length > 0) {
        productsTableBody.innerHTML = todayEntries.map(entry => {
            return `
                <tr>
                    <td>
                        ${entry.product_name}
                    </td>
                    <td class="text-center text-muted">${entry.weight}г</td>
                    <td class="text-center fw-bold">${Math.round(nutrition.calories)}</td>
                    <td class="text-center text-danger d-none d-sm-table-cell">${nutrition.protein.toFixed(1)}</td>
                    <td class="text-center text-warning d-none d-sm-table-cell">${nutrition.fat.toFixed(1)}</td>
                    <td class="text-center text-primary d-none d-sm-table-cell">${nutrition.carbs.toFixed(1)}</td>
                </tr>
            `;
        }).join('');
    } else {
        productsTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    Нет записей за этот день
                </td>
            </tr>
        `;
    }
    document.getElementById('productsCount').textContent = todayEntries.length;

    // ==================== РСК ====================
    const rskCaloriesProgress = document.getElementById('rskCaloriesProgress');
    document.getElementById('rskCaloriesPercent').textContent = `${caloriesPercent}%`;
    rskCaloriesProgress.style.width = `${caloriesPercentCapped}%`;
    rskCaloriesProgress.className = `progress-bar ${caloriesPercent > 100 ? 'bg-danger' : 'bg-success'}`;

    document.getElementById('rskProteinPercent').textContent = `${proteinPercent}%`;
    document.getElementById('rskProteinProgress').style.width = `${Math.min(100, proteinPercent)}%`;

    document.getElementById('rskFatPercent').textContent = `${fatPercent}%`;
    document.getElementById('rskFatProgress').style.width = `${Math.min(100, fatPercent)}%`;

    document.getElementById('rskCarbsPercent').textContent = `${carbsPercent}%`;
    document.getElementById('rskCarbsProgress').style.width = `${Math.min(100, carbsPercent)}%`;

    // ==================== ОСТАЛОСЬ / ПРЕВЫШЕНО ====================
    function formatRemaining(current, goal, unit) {
        const diff = goal - current;
        if (diff >= 0) {
            return `<span class="text-success">${diff.toFixed(1)} ${unit}</span>`;
        } else {
            return `<span class="text-danger">+${Math.abs(diff).toFixed(1)} ${unit}</span>`;
        }
    }

    document.getElementById('remainingCaloriesRow').innerHTML = formatRemaining(totals.calories, goals.calories, 'ккал');
    document.getElementById('remainingProteinRow').innerHTML = formatRemaining(totals.protein, goals.protein, 'г');
    document.getElementById('remainingFatRow').innerHTML = formatRemaining(totals.fat, goals.fat, 'г');
    document.getElementById('remainingCarbsRow').innerHTML = formatRemaining(totals.carbs, goals.carbs, 'г');

    // ==================== ПОЛЬЗОВАТЕЛЬСКИЕ ПОКАЗАТЕЛИ ====================
    document.getElementById('userWeight').textContent = userWeight;
    document.getElementById('totalProductsCount').textContent = todayEntries.length;
    document.getElementById('proteinPerKg').textContent = (totals.protein / userWeight).toFixed(2);
    document.getElementById('caloriesPerKg').textContent = (totals.calories / userWeight).toFixed(1);
}

// Загружаем данные при открытии страницы
loadData();
</script>
{% endblock %}